<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Process Introspection for Fun and Profit | evilsocket / Simone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="While studying Windows internals for my job, I had to  deepen my knowledge of executable loading process, including their memory layout, address relocations and so on.I came accross the PEB ( process">
<meta name="keywords" content="hooking,api hooking,emulator,win32,tib,process environment block,ldr,loader,pe,vm,malware,evasion">
<meta property="og:type" content="article">
<meta property="og:title" content="Process Introspection for Fun and Profit">
<meta property="og:url" content="https://www.evilsocket.net/2014/02/02/process-introspection-for-fun-and-profit/index.html">
<meta property="og:site_name" content="evilsocket &#x2F; Simone">
<meta property="og:description" content="While studying Windows internals for my job, I had to  deepen my knowledge of executable loading process, including their memory layout, address relocations and so on.I came accross the PEB ( process">
<meta property="og:updated_time" content="2014-02-03T13:26:14.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Process Introspection for Fun and Profit">
<meta name="twitter:description" content="While studying Windows internals for my job, I had to  deepen my knowledge of executable loading process, including their memory layout, address relocations and so on.I came accross the PEB ( process">
<meta name="twitter:creator" content="@evilsocket">
<link rel="publisher" href="https://plus.google.com/104794390596458308819">

  <meta name="google-site-verification" content="6qdVG0z0lac2ceITCoTCNm15CPp3K9Sq41_5IK4OLKM">

  
    <link rel="alternate" href="/atom.xml" title="evilsocket / Simone" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-22026549-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
  <script type="text/javascript" src="https://blockchain.info/Resources/js/pay-now-button.js"></script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">evilsocket / Simone</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">I hack stuff.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/random-facts-about-me.html">About</a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-github-link" class="nav-icon" href="https://github.com/evilsocket" target="_blank"></a>
        <a id="nav-linkedin-link" class="nav-icon" href="http://it.linkedin.com/in/simonemargaritelli/" target="_blank"></a>
        <a id="nav-twitter-link" class="nav-icon" href="https://twitter.com/evilsocket" target="_blank"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.evilsocket.net"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-process-introspection-for-fun-and-profit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Process Introspection for Fun and Profit
    </h1>
  

      </header>
    
    <br/>
    <div class="article-meta">
      Posted on <time datetime="2014-02-02T02:17:24.000Z" itemprop="datePublished">2014-02-02</time>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <br/>
        <div class="addthis_sharing_toolbox"></div>
        <p>While studying Windows internals for my job, I had to  deepen my knowledge of executable loading process, including their memory layout, address relocations and so on.<br>I came accross the <strong>PEB</strong> ( process environment block ), a data structure ( mostly undocumented ) that NT systems use internally to handle many aspects of a process, including a list of loaded libraries, environment variables, command line arguments, heap informations, TLS slots and so on.<br>The interesting fact about the PEB is that can be inspected to obtain those informations without the use of any standard API, thus resulting in an interesting technique to detect bad written virtual machines, emulators and any sort of sandboxing that could be used by a malware analyst or an anti virus product.<br>Moreover you could check the PEB to detect if a DLL has been injected into your process to perform api hooking.<br>API hooking softwares usually hooks API such as <strong>EnumProcessModules</strong> and patch them to hide the presence of the injected module. Inspecting the PEB you will be able to perform the same task only analyzing your address space, thus avoiding API patching.</p>
<a id="more"></a>
<p>The address of the structure in our process virtual memory can be obtained with the <strong>NtQueryInformationProcess</strong> API, once you have the address you can cast it to a pointer to the following type.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">  BYTE                    InheritedAddressSpace;</div><div class="line">  BYTE                    ReadImageFileExecOptions;</div><div class="line">  BYTE                    BeingDebugged;</div><div class="line">  BYTE                    Spare;</div><div class="line">  DWORD                   dwMutant;                              </div><div class="line">  DWORD                   dwImageBaseAddress;                                                      </div><div class="line">  PEB_LDR_DATA*           LoaderData;                                                                      </div><div class="line">  DWORD                   dwProcessParameters;                                                </div><div class="line">  DWORD                   dwSubSystemData;                     </div><div class="line">  DWORD                   dwProcessHeap;                       </div><div class="line">  DWORD                   dwFastPebLock;                       </div><div class="line">  DWORD                   dwFastPebLockRoutine;                </div><div class="line">  DWORD                   dwFastPebUnlockRoutine;              </div><div class="line">  DWORD                   dwEnvironmentUpdateCount;            </div><div class="line">  DWORD                   dwKernelCallbackTable;               </div><div class="line">  DWORD                   dwEventLogSection;                   </div><div class="line">  DWORD                   dwEventLog;                          </div><div class="line">  DWORD                   dwFreeList;                          </div><div class="line">  DWORD                   dwTlsExpansionCounter;               </div><div class="line">  DWORD                   dwTlsBitmap;                         </div><div class="line">  DWORD                   dwTlsBitmapBits[<span class="number">0x2</span>];</div><div class="line">  DWORD                   dwReadOnlySharedMemoryBase;</div><div class="line">  DWORD                   dwReadOnlySharedMemoryHeap;</div><div class="line">  DWORD                   dwReadOnlyStaticServerData;</div><div class="line">  DWORD                   dwAnsiCodePageData;</div><div class="line">  DWORD                   dwOemCodePageData;</div><div class="line">  DWORD                   dwUnicodeCaseTableData;</div><div class="line">  DWORD                   dwNumberOfProcessors;</div><div class="line">  DWORD                   dwNtGlobalFlag;</div><div class="line">  DWORD                   dwSpare2;</div><div class="line">  DWORD                   dwCriticalSectionTimeout1;</div><div class="line">  DWORD                   dwCriticalSectionTimeout2;</div><div class="line">  DWORD                   dwHeapSegmentReserve;</div><div class="line">  DWORD                   dwHeapSegmentCommit;</div><div class="line">  DWORD                   dwHeapDeCommitTotalFreeThreshold;</div><div class="line">  DWORD                   dwHeapDeCommitFreeBlockThreshold;</div><div class="line">  DWORD                   dwNumberOfHeaps;                              </div><div class="line">  DWORD                   dwMaximumNumberOfHeaps;                        </div><div class="line">  DWORD                   *ProcessHeaps;                               </div><div class="line">  DWORD                   dwGdiSharedHandleTable;</div><div class="line">  DWORD                   dwProcessStarterHelper;</div><div class="line">  DWORD                   dwGdiDCAttributeList;</div><div class="line">  DWORD                   dwLoaderLock;</div><div class="line">  DWORD                   dwOSMajorVersion;</div><div class="line">  DWORD                   dwOSMinorVersion;</div><div class="line">  DWORD                   dwOSBuildNumber;</div><div class="line">  DWORD                   dwOSPlatformId;</div><div class="line">  DWORD                   dwImageSubSystem;</div><div class="line">  DWORD                   dwImageSubSystemMajorVersion;</div><div class="line">  DWORD                   dwImageSubSystemMinorVersion;</div><div class="line">  DWORD                   GdiHandleBuffer[<span class="number">0x22</span>];</div><div class="line">  DWORD                   dwPostProcessInitRoutine;</div><div class="line">  DWORD                   dwTlsExpansionBitmap;</div><div class="line">  BYTE                    TlsExpansionBitmapBits[<span class="number">0x80</span>];</div><div class="line">  DWORD                   dwSessionId;</div><div class="line">&#125;</div><div class="line">PEB;</div></pre></td></tr></table></figure>
<p>As you can see there’s a lot that can be tested to evade sandboxing software due to the fact that most of them won’t emulate a correct PEB, the following source code will demonstrate how to read it and print many informations about the process.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PROCESS_BASIC_INFORMATION</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">  PVOID Reserved1;</div><div class="line">  PVOID PebBaseAddress;</div><div class="line">  PVOID Reserved2[<span class="number">2</span>];</div><div class="line">  ULONG_PTR UniqueProcessId;</div><div class="line">  PVOID Reserved3;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">  BYTE       Reserved1[<span class="number">8</span>];</div><div class="line">  PVOID      Reserved2[<span class="number">3</span>];</div><div class="line">  LIST_ENTRY InMemoryOrderModuleList;</div><div class="line">&#125;</div><div class="line">PEB_LDR_DATA ;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TIB</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">  PEXCEPTION_REGISTRATION_RECORD* ExceptionList; <span class="comment">// FS:0x00</span></div><div class="line">  DWORD dwStackBase;                             <span class="comment">// FS:0x04</span></div><div class="line">  DWORD dwStackLimit;                            <span class="comment">// FS:0x08</span></div><div class="line">  DWORD dwSubSystemTib;                          <span class="comment">// FS:0x0C</span></div><div class="line">  DWORD dwFiberData;                             <span class="comment">// FS:0x10</span></div><div class="line">  DWORD dwArbitraryUserPointer;                  <span class="comment">// FS:0x14</span></div><div class="line">  DWORD dwTIBOffset;                             <span class="comment">// FS:0x18</span></div><div class="line">&#125;</div><div class="line">TIB;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">  BYTE                    InheritedAddressSpace;</div><div class="line">  BYTE                    ReadImageFileExecOptions;</div><div class="line">  BYTE                    BeingDebugged;</div><div class="line">  BYTE                    Spare;</div><div class="line">  DWORD                   dwMutant;                              </div><div class="line">  DWORD                   dwImageBaseAddress;                                                      </div><div class="line">  PEB_LDR_DATA*           LoaderData;                                                                      </div><div class="line">  DWORD                   dwProcessParameters;                                                </div><div class="line">  DWORD                   dwSubSystemData;                     </div><div class="line">  DWORD                   dwProcessHeap;                       </div><div class="line">  DWORD                   dwFastPebLock;                       </div><div class="line">  DWORD                   dwFastPebLockRoutine;                </div><div class="line">  DWORD                   dwFastPebUnlockRoutine;              </div><div class="line">  DWORD                   dwEnvironmentUpdateCount;            </div><div class="line">  DWORD                   dwKernelCallbackTable;               </div><div class="line">  DWORD                   dwEventLogSection;                   </div><div class="line">  DWORD                   dwEventLog;                          </div><div class="line">  DWORD                   dwFreeList;                          </div><div class="line">  DWORD                   dwTlsExpansionCounter;               </div><div class="line">  DWORD                   dwTlsBitmap;                         </div><div class="line">  DWORD                   dwTlsBitmapBits[<span class="number">0x2</span>];</div><div class="line">  DWORD                   dwReadOnlySharedMemoryBase;</div><div class="line">  DWORD                   dwReadOnlySharedMemoryHeap;</div><div class="line">  DWORD                   dwReadOnlyStaticServerData;</div><div class="line">  DWORD                   dwAnsiCodePageData;</div><div class="line">  DWORD                   dwOemCodePageData;</div><div class="line">  DWORD                   dwUnicodeCaseTableData;</div><div class="line">  DWORD                   dwNumberOfProcessors;</div><div class="line">  DWORD                   dwNtGlobalFlag;</div><div class="line">  DWORD                   dwSpare2;</div><div class="line">  DWORD                   dwCriticalSectionTimeout1;</div><div class="line">  DWORD                   dwCriticalSectionTimeout2;</div><div class="line">  DWORD                   dwHeapSegmentReserve;</div><div class="line">  DWORD                   dwHeapSegmentCommit;</div><div class="line">  DWORD                   dwHeapDeCommitTotalFreeThreshold;</div><div class="line">  DWORD                   dwHeapDeCommitFreeBlockThreshold;</div><div class="line">  DWORD                   dwNumberOfHeaps;                              </div><div class="line">  DWORD                   dwMaximumNumberOfHeaps;                        </div><div class="line">  DWORD                   *ProcessHeaps;                               </div><div class="line">  DWORD                   dwGdiSharedHandleTable;</div><div class="line">  DWORD                   dwProcessStarterHelper;</div><div class="line">  DWORD                   dwGdiDCAttributeList;</div><div class="line">  DWORD                   dwLoaderLock;</div><div class="line">  DWORD                   dwOSMajorVersion;</div><div class="line">  DWORD                   dwOSMinorVersion;</div><div class="line">  DWORD                   dwOSBuildNumber;</div><div class="line">  DWORD                   dwOSPlatformId;</div><div class="line">  DWORD                   dwImageSubSystem;</div><div class="line">  DWORD                   dwImageSubSystemMajorVersion;</div><div class="line">  DWORD                   dwImageSubSystemMinorVersion;</div><div class="line">  DWORD                   GdiHandleBuffer[<span class="number">0x22</span>];</div><div class="line">  DWORD                   dwPostProcessInitRoutine;</div><div class="line">  DWORD                   dwTlsExpansionBitmap;</div><div class="line">  BYTE                    TlsExpansionBitmapBits[<span class="number">0x80</span>];</div><div class="line">  DWORD                   dwSessionId;</div><div class="line">&#125;</div><div class="line">PEB;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">UNICODE_STRING</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">  USHORT Length;</div><div class="line">  USHORT MaximumLength;</div><div class="line">  PWSTR  Buffer;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">LDR_MODULE</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">  LIST_ENTRY              InLoadOrderModuleList;</div><div class="line">  LIST_ENTRY              InMemoryOrderModuleList;</div><div class="line">  LIST_ENTRY              InInitializationOrderModuleList;</div><div class="line">  PVOID                   BaseAddress;</div><div class="line">  PVOID                   EntryPoint;</div><div class="line">  ULONG                   SizeOfImage;</div><div class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">UNICODE_STRING</span>  <span class="title">FullDllName</span>;</span></div><div class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">UNICODE_STRING</span>  <span class="title">BaseDllName</span>;</span></div><div class="line">  ULONG                   Flags;</div><div class="line">  SHORT                   LoadCount;</div><div class="line">  SHORT                   TlsIndex;</div><div class="line">  LIST_ENTRY              HashTableEntry;</div><div class="line">  ULONG                   TimeDateStamp;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">enum</span> PROCESSINFOCLASS</div><div class="line">&#123;</div><div class="line">  ProcessBasicInformation = <span class="number">0</span>,</div><div class="line">  ProcessDebugPort = <span class="number">7</span>,</div><div class="line">  ProcessWow64Information = <span class="number">26</span>,</div><div class="line">  ProcessImageFileName = <span class="number">27</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(*NtQueryInformationProcess_T)</span><span class="params">( HANDLE, <span class="keyword">enum</span> PROCESSINFOCLASS, PVOID, ULONG, PULONG )</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  HMODULE hNtdll;</div><div class="line">  NTSTATUS status;</div><div class="line">  ULONG bytesReturned;</div><div class="line">  PLIST_ENTRY lEntry;</div><div class="line">  NtQueryInformationProcess_T pfnNtQueryInformationProcess;</div><div class="line">  DWORD dwTIB;</div><div class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">PROCESS_BASIC_INFORMATION</span> <span class="title">basicInfo</span>;</span></div><div class="line">  PEB* peb;</div><div class="line">  TIB *tib;</div><div class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">LDR_MODULE</span> *<span class="title">pLdrModule</span>;</span></div><div class="line"></div><div class="line">  hNtdll = LoadLibrary(<span class="string">L"ntdll.dll"</span>);</div><div class="line"></div><div class="line">  pfnNtQueryInformationProcess = (NtQueryInformationProcess_T)GetProcAddress(hNtdll, <span class="string">"NtQueryInformationProcess"</span> );</div><div class="line"></div><div class="line">  assert(pfnNtQueryInformationProcess != <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">  status = pfnNtQueryInformationProcess( GetCurrentProcess(), ProcessBasicInformation, &amp;basicInfo, <span class="keyword">sizeof</span>(basicInfo), &amp;bytesReturned );</div><div class="line"></div><div class="line">  assert(status == <span class="number">0</span> &amp;&amp; bytesReturned == <span class="keyword">sizeof</span>(basicInfo));</div><div class="line"></div><div class="line">  <span class="comment">// get our TIB address ( same as mov eax, fs:0x18 )</span></div><div class="line">  dwTIB = __readfsdword(<span class="number">0x18</span>);</div><div class="line">  tib = (TIB *)dwTIB;</div><div class="line"></div><div class="line">  <span class="comment">// get our PEB address</span></div><div class="line">  peb = (PEB *)basicInfo.PebBaseAddress;</div><div class="line"></div><div class="line">  <span class="built_in">printf</span>( <span class="string">"TIB.ExceptionList          : %08X\n"</span>, tib-&gt;ExceptionList );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"TIB.dwStackBase            : %08X\n"</span>, tib-&gt;dwStackBase );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"TIB.dwStackLimit           : %08X\n"</span>, tib-&gt;dwStackLimit );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"TIB.dwSubSystemTib         : %08X\n"</span>, tib-&gt;dwSubSystemTib );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"TIB.dwFiberData            : %08X\n"</span>, tib-&gt;dwFiberData );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"TIB.dwArbitraryUserPointer : %08X\n"</span>, tib-&gt;dwArbitraryUserPointer );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"TIB.dwTIBOffset            : %08X\n"</span>, tib-&gt;dwTIBOffset );</div><div class="line"></div><div class="line">  <span class="built_in">printf</span>( <span class="string">"\n"</span> );</div><div class="line"></div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.InheritedAddressSpace : %08X\n"</span>, peb-&gt;InheritedAddressSpace );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.ReadImageFileExecOptions : %08X\n"</span>, peb-&gt;ReadImageFileExecOptions );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.BeingDebugged : %08X\n"</span>, peb-&gt;BeingDebugged );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.Spare : %08X\n"</span>, peb-&gt;Spare );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwMutant : %08X\n"</span>, peb-&gt;dwMutant );                              </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwImageBaseAddress : %08X\n"</span>, peb-&gt;dwImageBaseAddress );                                                      </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.LoaderData : %08X\n"</span>, peb-&gt;LoaderData );                                                                      </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwProcessParameters : %08X\n"</span>, peb-&gt;dwProcessParameters );                                                </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwSubSystemData : %08X\n"</span>, peb-&gt;dwSubSystemData );                     </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwProcessHeap : %08X\n"</span>, peb-&gt;dwProcessHeap );                       </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwFastPebLock : %08X\n"</span>, peb-&gt;dwFastPebLock );                       </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwFastPebLockRoutine : %08X\n"</span>, peb-&gt;dwFastPebLockRoutine );                </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwFastPebUnlockRoutine : %08X\n"</span>, peb-&gt;dwFastPebUnlockRoutine );              </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwEnvironmentUpdateCount : %08X\n"</span>, peb-&gt;dwEnvironmentUpdateCount );            </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwKernelCallbackTable : %08X\n"</span>, peb-&gt;dwKernelCallbackTable );               </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwEventLogSection : %08X\n"</span>, peb-&gt;dwEventLogSection );                   </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwEventLog : %08X\n"</span>, peb-&gt;dwEventLog );                          </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwFreeList : %08X\n"</span>, peb-&gt;dwFreeList );                          </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwTlsExpansionCounter : %08X\n"</span>, peb-&gt;dwTlsExpansionCounter );               </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwTlsBitmap : %08X\n"</span>, peb-&gt;dwTlsBitmap );                         </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwReadOnlySharedMemoryBase : %08X\n"</span>, peb-&gt;dwReadOnlySharedMemoryBase );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwReadOnlySharedMemoryHeap : %08X\n"</span>, peb-&gt;dwReadOnlySharedMemoryHeap );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwReadOnlyStaticServerData : %08X\n"</span>, peb-&gt;dwReadOnlyStaticServerData );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwAnsiCodePageData : %08X\n"</span>, peb-&gt;dwAnsiCodePageData );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwOemCodePageData : %08X\n"</span>, peb-&gt;dwOemCodePageData );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwUnicodeCaseTableData : %08X\n"</span>, peb-&gt;dwUnicodeCaseTableData );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwNumberOfProcessors : %08X\n"</span>, peb-&gt;dwNumberOfProcessors );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwNtGlobalFlag : %08X\n"</span>, peb-&gt;dwNtGlobalFlag );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwSpare2 : %08X\n"</span>, peb-&gt;dwSpare2 );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwCriticalSectionTimeout1 : %08X\n"</span>, peb-&gt;dwCriticalSectionTimeout1 );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwCriticalSectionTimeout2 : %08X\n"</span>, peb-&gt;dwCriticalSectionTimeout2 );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwHeapSegmentReserve : %08X\n"</span>, peb-&gt;dwHeapSegmentReserve );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwHeapSegmentCommit : %08X\n"</span>, peb-&gt;dwHeapSegmentCommit );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwHeapDeCommitTotalFreeThreshold : %08X\n"</span>, peb-&gt;dwHeapDeCommitTotalFreeThreshold );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwHeapDeCommitFreeBlockThreshold : %08X\n"</span>, peb-&gt;dwHeapDeCommitFreeBlockThreshold );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwNumberOfHeaps : %08X\n"</span>, peb-&gt;dwNumberOfHeaps );                              </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwMaximumNumberOfHeaps : %08X\n"</span>, peb-&gt;dwMaximumNumberOfHeaps );                        </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.*ProcessHeaps : %08X\n"</span>, peb-&gt;ProcessHeaps );                               </div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwGdiSharedHandleTable : %08X\n"</span>, peb-&gt;dwGdiSharedHandleTable );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwProcessStarterHelper : %08X\n"</span>, peb-&gt;dwProcessStarterHelper );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwGdiDCAttributeList : %08X\n"</span>, peb-&gt;dwGdiDCAttributeList );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwLoaderLock : %08X\n"</span>, peb-&gt;dwLoaderLock );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwOSMajorVersion : %08X\n"</span>, peb-&gt;dwOSMajorVersion );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwOSMinorVersion : %08X\n"</span>, peb-&gt;dwOSMinorVersion );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwOSBuildNumber : %08X\n"</span>, peb-&gt;dwOSBuildNumber );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwOSPlatformId : %08X\n"</span>, peb-&gt;dwOSPlatformId );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwImageSubSystem : %08X\n"</span>, peb-&gt;dwImageSubSystem );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwImageSubSystemMajorVersion : %08X\n"</span>, peb-&gt;dwImageSubSystemMajorVersion );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwImageSubSystemMinorVersion : %08X\n"</span>, peb-&gt;dwImageSubSystemMinorVersion );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwPostProcessInitRoutine : %08X\n"</span>, peb-&gt;dwPostProcessInitRoutine );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwTlsExpansionBitmap : %08X\n"</span>, peb-&gt;dwTlsExpansionBitmap );</div><div class="line">  <span class="built_in">printf</span>( <span class="string">"PEB.dwSessionId : %08X\n"</span>, peb-&gt;dwSessionId );</div><div class="line"></div><div class="line">  <span class="built_in">printf</span>( <span class="string">"\n"</span> );</div><div class="line"></div><div class="line">  <span class="comment">// get the main module</span></div><div class="line">  pLdrModule = (struct LDR_MODULE*)peb-&gt;LoaderData-&gt;InMemoryOrderModuleList.Flink;</div><div class="line"></div><div class="line">  <span class="built_in">printf</span></div><div class="line">  (</div><div class="line">    <span class="string">"%-17S base@ %10p size: %10x flags: %12x\n"</span>,</div><div class="line">    pLdrModule-&gt;FullDllName.Buffer,</div><div class="line">    pLdrModule-&gt;BaseAddress,</div><div class="line">    pLdrModule-&gt;SizeOfImage,</div><div class="line">    pLdrModule-&gt;Flags</div><div class="line">  );</div><div class="line"></div><div class="line">  <span class="comment">// loop each loaded module</span></div><div class="line">  <span class="keyword">for</span>( lEntry = peb-&gt;LoaderData-&gt;InMemoryOrderModuleList.Flink-&gt;Flink; pLdrModule-&gt;BaseAddress != <span class="number">0</span>; lEntry = lEntry-&gt;Flink )</div><div class="line">  &#123;</div><div class="line">    pLdrModule = (struct LDR_MODULE*)lEntry;</div><div class="line"></div><div class="line">    <span class="built_in">printf</span></div><div class="line">    (</div><div class="line">      <span class="string">"%-17S base@ %10p size: %10x flags: %12x\n"</span>,</div><div class="line">      pLdrModule-&gt;FullDllName.Buffer,</div><div class="line">      pLdrModule-&gt;BaseAddress,</div><div class="line">      pLdrModule-&gt;SizeOfImage,</div><div class="line">      pLdrModule-&gt;Flags</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  FreeLibrary( hNtdll );</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
      
      <hr/>
      <center>

        <div style="font-size:16px;margin:0 auto;width:300px" class="blockchain-btn"
        data-address="16xFm5NrKV6eEV4TTDEUdkjqe62L352apW"
        data-shared="false">
        <div class="blockchain stage-begin">
        <img src="https://blockchain.info/Resources/buttons/donate_64.png"/>
        </div>
        <div class="blockchain stage-loading" style="text-align:center">
        <img src="https://blockchain.info/Resources/loading-large.gif"/>
        </div>
        <div class="blockchain stage-ready">
        <p align="center">Please Donate To Bitcoin Address: <b>[[address]]</b></p>
        <p align="center" class="qr-code"></p>
        </div>
        <div class="blockchain stage-paid">
        Donation of <b>[[value]] BTC</b> Received. Thank You.
        </div>
        <div class="blockchain stage-error">
        <font color="red">[[error]]</font>
        </div>
        </div>

        <p style="font-size:27px">
            Let's stay in touch!
            <br/>
            <a href="https://twitter.com/evilsocket" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @evilsocket</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        </p>
      </center>
      
    </div>
    <footer class="article-footer">
      
        <a href="https://www.evilsocket.net/2014/02/02/process-introspection-for-fun-and-profit/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/api-hooking/">api hooking</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/emulator/">emulator</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/evasion/">evasion</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hooking/">hooking</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ldr/">ldr</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/loader/">loader</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/malware/">malware</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pe/">pe</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/process-environment-block/">process environment block</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tib/">tib</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vm/">vm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/win32/">win32</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/02/05/termination-and-injection-self-defense-on-windows/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Termination and Injection Self Defense on Windows &gt;= Vista SP1
        
      </div>
    </a>
  
  
    <a href="/2014/02/01/keservicedescriptortable-patching-aka-how-to-hook-win32-api-patching-the-kernel/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">How to Hook Win32 API With Kernel Patching</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Simone Margaritelli<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4da572964da15ce9" async="async"></script>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/random-facts-about-me.html" class="mobile-nav-link">About</a>
  
</nav>
    
<script>
  var disqus_shortname = 'evilsocket';
  
  var disqus_url = 'https://www.evilsocket.net/2014/02/02/process-introspection-for-fun-and-profit/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>